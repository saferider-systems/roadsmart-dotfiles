DELIMITER //
DROP PROCEDURE IF EXISTS MigrateWithWeeklyPartitions//
CREATE PROCEDURE MigrateWithWeeklyPartitions(
IN start_id BIGINT,
IN end_id BIGINT
)
BEGIN
-- 1. Create the skeleton using the production schema
DROP TABLE IF EXISTS transmissions_test;
CREATE TABLE transmissions_test LIKE _transmissions;
    
-- 2. Modify the Primary Key (Instant on empty table)
ALTER TABLE transmissions_test
DROP PRIMARY KEY,
ADD PRIMARY KEY (id, received_date_time);
    
-- 3. Add Weekly Partitions (January 2026 to January 2028)
-- Partitions are named p_YYYY_wWW where WW is the ISO week number
ALTER TABLE transmissions_test
PARTITION BY RANGE COLUMNS(received_date_time) (
-- January 2026
PARTITION p_2026_w01 VALUES LESS THAN ('2026-01-05 00:00:00'),
PARTITION p_2026_w02 VALUES LESS THAN ('2026-01-12 00:00:00'),
PARTITION p_2026_w03 VALUES LESS THAN ('2026-01-19 00:00:00'),
PARTITION p_2026_w04 VALUES LESS THAN ('2026-01-26 00:00:00'),
-- February 2026
PARTITION p_2026_w05 VALUES LESS THAN ('2026-02-02 00:00:00'),
PARTITION p_2026_w06 VALUES LESS THAN ('2026-02-09 00:00:00'),
PARTITION p_2026_w07 VALUES LESS THAN ('2026-02-16 00:00:00'),
PARTITION p_2026_w08 VALUES LESS THAN ('2026-02-23 00:00:00'),
-- March 2026
PARTITION p_2026_w09 VALUES LESS THAN ('2026-03-02 00:00:00'),
PARTITION p_2026_w10 VALUES LESS THAN ('2026-03-09 00:00:00'),
PARTITION p_2026_w11 VALUES LESS THAN ('2026-03-16 00:00:00'),
PARTITION p_2026_w12 VALUES LESS THAN ('2026-03-23 00:00:00'),
PARTITION p_2026_w13 VALUES LESS THAN ('2026-03-30 00:00:00'),
-- April 2026
PARTITION p_2026_w14 VALUES LESS THAN ('2026-04-06 00:00:00'),
PARTITION p_2026_w15 VALUES LESS THAN ('2026-04-13 00:00:00'),
PARTITION p_2026_w16 VALUES LESS THAN ('2026-04-20 00:00:00'),
PARTITION p_2026_w17 VALUES LESS THAN ('2026-04-27 00:00:00'),
-- May 2026
PARTITION p_2026_w18 VALUES LESS THAN ('2026-05-04 00:00:00'),
PARTITION p_2026_w19 VALUES LESS THAN ('2026-05-11 00:00:00'),
PARTITION p_2026_w20 VALUES LESS THAN ('2026-05-18 00:00:00'),
PARTITION p_2026_w21 VALUES LESS THAN ('2026-05-25 00:00:00'),
-- June 2026
PARTITION p_2026_w22 VALUES LESS THAN ('2026-06-01 00:00:00'),
PARTITION p_2026_w23 VALUES LESS THAN ('2026-06-08 00:00:00'),
PARTITION p_2026_w24 VALUES LESS THAN ('2026-06-15 00:00:00'),
PARTITION p_2026_w25 VALUES LESS THAN ('2026-06-22 00:00:00'),
PARTITION p_2026_w26 VALUES LESS THAN ('2026-06-29 00:00:00'),
-- July 2026
PARTITION p_2026_w27 VALUES LESS THAN ('2026-07-06 00:00:00'),
PARTITION p_2026_w28 VALUES LESS THAN ('2026-07-13 00:00:00'),
PARTITION p_2026_w29 VALUES LESS THAN ('2026-07-20 00:00:00'),
PARTITION p_2026_w30 VALUES LESS THAN ('2026-07-27 00:00:00'),
-- August 2026
PARTITION p_2026_w31 VALUES LESS THAN ('2026-08-03 00:00:00'),
PARTITION p_2026_w32 VALUES LESS THAN ('2026-08-10 00:00:00'),
PARTITION p_2026_w33 VALUES LESS THAN ('2026-08-17 00:00:00'),
PARTITION p_2026_w34 VALUES LESS THAN ('2026-08-24 00:00:00'),
PARTITION p_2026_w35 VALUES LESS THAN ('2026-08-31 00:00:00'),
-- September 2026
PARTITION p_2026_w36 VALUES LESS THAN ('2026-09-07 00:00:00'),
PARTITION p_2026_w37 VALUES LESS THAN ('2026-09-14 00:00:00'),
PARTITION p_2026_w38 VALUES LESS THAN ('2026-09-21 00:00:00'),
PARTITION p_2026_w39 VALUES LESS THAN ('2026-09-28 00:00:00'),
-- October 2026
PARTITION p_2026_w40 VALUES LESS THAN ('2026-10-05 00:00:00'),
PARTITION p_2026_w41 VALUES LESS THAN ('2026-10-12 00:00:00'),
PARTITION p_2026_w42 VALUES LESS THAN ('2026-10-19 00:00:00'),
PARTITION p_2026_w43 VALUES LESS THAN ('2026-10-26 00:00:00'),
-- November 2026
PARTITION p_2026_w44 VALUES LESS THAN ('2026-11-02 00:00:00'),
PARTITION p_2026_w45 VALUES LESS THAN ('2026-11-09 00:00:00'),
PARTITION p_2026_w46 VALUES LESS THAN ('2026-11-16 00:00:00'),
PARTITION p_2026_w47 VALUES LESS THAN ('2026-11-23 00:00:00'),
PARTITION p_2026_w48 VALUES LESS THAN ('2026-11-30 00:00:00'),
-- December 2026
PARTITION p_2026_w49 VALUES LESS THAN ('2026-12-07 00:00:00'),
PARTITION p_2026_w50 VALUES LESS THAN ('2026-12-14 00:00:00'),
PARTITION p_2026_w51 VALUES LESS THAN ('2026-12-21 00:00:00'),
PARTITION p_2026_w52 VALUES LESS THAN ('2026-12-28 00:00:00'),
        
-- 2027 Partitions
-- January 2027
PARTITION p_2027_w01 VALUES LESS THAN ('2027-01-04 00:00:00'),
PARTITION p_2027_w02 VALUES LESS THAN ('2027-01-11 00:00:00'),
PARTITION p_2027_w03 VALUES LESS THAN ('2027-01-18 00:00:00'),
PARTITION p_2027_w04 VALUES LESS THAN ('2027-01-25 00:00:00'),
-- February 2027
PARTITION p_2027_w05 VALUES LESS THAN ('2027-02-01 00:00:00'),
PARTITION p_2027_w06 VALUES LESS THAN ('2027-02-08 00:00:00'),
PARTITION p_2027_w07 VALUES LESS THAN ('2027-02-15 00:00:00'),
PARTITION p_2027_w08 VALUES LESS THAN ('2027-02-22 00:00:00'),
-- March 2027
PARTITION p_2027_w09 VALUES LESS THAN ('2027-03-01 00:00:00'),
PARTITION p_2027_w10 VALUES LESS THAN ('2027-03-08 00:00:00'),
PARTITION p_2027_w11 VALUES LESS THAN ('2027-03-15 00:00:00'),
PARTITION p_2027_w12 VALUES LESS THAN ('2027-03-22 00:00:00'),
PARTITION p_2027_w13 VALUES LESS THAN ('2027-03-29 00:00:00'),
-- April 2027
PARTITION p_2027_w14 VALUES LESS THAN ('2027-04-05 00:00:00'),
PARTITION p_2027_w15 VALUES LESS THAN ('2027-04-12 00:00:00'),
PARTITION p_2027_w16 VALUES LESS THAN ('2027-04-19 00:00:00'),
PARTITION p_2027_w17 VALUES LESS THAN ('2027-04-26 00:00:00'),
-- May 2027
PARTITION p_2027_w18 VALUES LESS THAN ('2027-05-03 00:00:00'),
PARTITION p_2027_w19 VALUES LESS THAN ('2027-05-10 00:00:00'),
PARTITION p_2027_w20 VALUES LESS THAN ('2027-05-17 00:00:00'),
PARTITION p_2027_w21 VALUES LESS THAN ('2027-05-24 00:00:00'),
PARTITION p_2027_w22 VALUES LESS THAN ('2027-05-31 00:00:00'),
-- June 2027
PARTITION p_2027_w23 VALUES LESS THAN ('2027-06-07 00:00:00'),
PARTITION p_2027_w24 VALUES LESS THAN ('2027-06-14 00:00:00'),
PARTITION p_2027_w25 VALUES LESS THAN ('2027-06-21 00:00:00'),
PARTITION p_2027_w26 VALUES LESS THAN ('2027-06-28 00:00:00'),
-- July 2027
PARTITION p_2027_w27 VALUES LESS THAN ('2027-07-05 00:00:00'),
PARTITION p_2027_w28 VALUES LESS THAN ('2027-07-12 00:00:00'),
PARTITION p_2027_w29 VALUES LESS THAN ('2027-07-19 00:00:00'),
PARTITION p_2027_w30 VALUES LESS THAN ('2027-07-26 00:00:00'),
-- August 2027
PARTITION p_2027_w31 VALUES LESS THAN ('2027-08-02 00:00:00'),
PARTITION p_2027_w32 VALUES LESS THAN ('2027-08-09 00:00:00'),
PARTITION p_2027_w33 VALUES LESS THAN ('2027-08-16 00:00:00'),
PARTITION p_2027_w34 VALUES LESS THAN ('2027-08-23 00:00:00'),
PARTITION p_2027_w35 VALUES LESS THAN ('2027-08-30 00:00:00'),
-- September 2027
PARTITION p_2027_w36 VALUES LESS THAN ('2027-09-06 00:00:00'),
PARTITION p_2027_w37 VALUES LESS THAN ('2027-09-13 00:00:00'),
PARTITION p_2027_w38 VALUES LESS THAN ('2027-09-20 00:00:00'),
PARTITION p_2027_w39 VALUES LESS THAN ('2027-09-27 00:00:00'),
-- October 2027
PARTITION p_2027_w40 VALUES LESS THAN ('2027-10-04 00:00:00'),
PARTITION p_2027_w41 VALUES LESS THAN ('2027-10-11 00:00:00'),
PARTITION p_2027_w42 VALUES LESS THAN ('2027-10-18 00:00:00'),
PARTITION p_2027_w43 VALUES LESS THAN ('2027-10-25 00:00:00'),
-- November 2027
PARTITION p_2027_w44 VALUES LESS THAN ('2027-11-01 00:00:00'),
PARTITION p_2027_w45 VALUES LESS THAN ('2027-11-08 00:00:00'),
PARTITION p_2027_w46 VALUES LESS THAN ('2027-11-15 00:00:00'),
PARTITION p_2027_w47 VALUES LESS THAN ('2027-11-22 00:00:00'),
PARTITION p_2027_w48 VALUES LESS THAN ('2027-11-29 00:00:00'),
-- December 2027
PARTITION p_2027_w49 VALUES LESS THAN ('2027-12-06 00:00:00'),
PARTITION p_2027_w50 VALUES LESS THAN ('2027-12-13 00:00:00'),
PARTITION p_2027_w51 VALUES LESS THAN ('2027-12-20 00:00:00'),
PARTITION p_2027_w52 VALUES LESS THAN ('2027-12-27 00:00:00'),
        
-- January 2028
PARTITION p_2028_w01 VALUES LESS THAN ('2028-01-03 00:00:00'),
PARTITION p_2028_w02 VALUES LESS THAN ('2028-01-10 00:00:00'),
PARTITION p_2028_w03 VALUES LESS THAN ('2028-01-17 00:00:00'),
PARTITION p_2028_w04 VALUES LESS THAN ('2028-01-24 00:00:00'),
PARTITION p_2028_w05 VALUES LESS THAN ('2028-01-31 00:00:00'),
        
-- Future partition for anything beyond
PARTITION p_future VALUES LESS THAN (MAXVALUE)
);
    
-- 4. Drop the heavy index before the big move
-- Crucial for performance when moving millions of rows.
ALTER TABLE transmissions_test DROP INDEX id_transmissions_field;
    
-- 5. Perform the Bulk Insert
INSERT INTO transmissions_test
SELECT * FROM _transmissions
WHERE id >= start_id AND id < end_id;
    
-- 6. Rebuild the Composite Index
-- Rebuilding on larger partitions is faster than rebuilding on many small ones.
ALTER TABLE transmissions_test ADD INDEX id_transmissions_field
(tracker_id, received_date_time, report_date_time, vehicle_registration);
END//
DELIMITER ;
